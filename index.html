<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RandoMusic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #05070a; color: white; font-family: sans-serif; height: 100vh; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }
        .btn-play { width: 220px; height: 220px; border-radius: 50%; background: #6366f1; border: none; box-shadow: 0 0 50px rgba(99, 102, 241, 0.4); display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; }
        .btn-play:active { transform: scale(0.95); }
        .visualizer { position: absolute; width: 350px; height: 350px; pointer-events: none; z-index: 5; }
        #setup { position: fixed; inset: 0; background: #05070a; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .progress-container { width: 80%; max-width: 300px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 20px; }
        #progress-bar { height: 100%; background: #6366f1; width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>

    <div id="setup">
        <i class="fas fa-folder-open text-6xl text-indigo-500 mb-6"></i>
        <h1 class="text-2xl font-bold mb-2">Configuración</h1>
        <p class="text-gray-400 mb-8 text-sm">Selecciona tu carpeta de música para empezar.</p>
        <label class="bg-white text-black px-8 py-4 rounded-full font-bold cursor-pointer">
            ELEGIR CARPETA
            <input type="file" id="folder-input" webkitdirectory directory multiple class="hidden">
        </label>
    </div>

    <div class="text-center">
        <h1 class="text-3xl font-black italic tracking-tighter">RANDOMUSIC</h1>
        <p id="count" class="text-indigo-400 text-[10px] font-bold mt-2 uppercase tracking-widest"></p>
    </div>

    <div class="relative flex items-center justify-center">
        <canvas id="visualizer" class="visualizer"></canvas>
        <button id="play-btn" class="btn-play">
            <i id="icon" class="fas fa-play text-5xl"></i>
        </button>
    </div>

    <div class="w-full flex flex-col items-center">
        <p id="song-name" class="text-sm font-medium text-gray-400 px-6 truncate max-w-xs"></p>
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <audio id="player"></audio>

    <script>
        const player = document.getElementById('player');
        const playBtn = document.getElementById('play-btn');
        const folderInput = document.getElementById('folder-input');
        const setup = document.getElementById('setup');
        const songName = document.getElementById('song-name');
        const icon = document.getElementById('icon');
        const progressBar = document.getElementById('progress-bar');
        const countDisplay = document.getElementById('count');

        let tracks = [];
        let context, analyser, src, data;

        folderInput.onchange = (e) => {
            tracks = Array.from(e.target.files).filter(f => f.type.startsWith('audio/'));
            if (tracks.length > 0) {
                setup.style.display = 'none';
                countDisplay.innerText = `${tracks.length} Canciones`;
            }
        };

        playBtn.onclick = () => {
            if (tracks.length === 0) return;
            
            if (!context) {
                context = new (window.AudioContext || window.webkitAudioContext)();
                analyser = context.createAnalyser();
                src = context.createMediaElementSource(player);
                src.connect(analyser);
                analyser.connect(context.destination);
                analyser.fftSize = 128;
                data = new Uint8Array(analyser.frequencyBinCount);
                draw();
            }

            const randomTrack = tracks[Math.floor(Math.random() * tracks.length)];
            player.src = URL.createObjectURL(randomTrack);
            songName.innerText = randomTrack.name;
            icon.className = "fas fa-pause";
            player.play();
        };

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(data);
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            canvas.width = 350; canvas.height = 350;
            const cx = 175, cy = 175, r = 115;
            data.forEach((v, i) => {
                const a = (i / data.length) * Math.PI * 2;
                const l = (v / 255) * 50;
                ctx.beginPath();
                ctx.strokeStyle = `hsla(${230 + i}, 70%, 60%, 0.8)`;
                ctx.lineWidth = 3;
                ctx.moveTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
                ctx.lineTo(cx + Math.cos(a)*(r+l), cy + Math.sin(a)*(r+l));
                ctx.stroke();
            });
        }

        player.ontimeupdate = () => progressBar.style.width = (player.currentTime / player.duration * 100) + '%';
        player.onended = () => playBtn.onclick();
    </script>
</body>
</html>